[from-internal-custom]
exten => 8000,1,Answer()
exten => 8000,n,Wait(1)
exten => 8000,n,Set(extension=${CALLERID(num)})
exten => 8000,n,Set(current_day=${STRFTIME(${EPOCH},,%w)})
exten => 8000,n,Set(current_hour=${STRFTIME(${EPOCH},,%H)})
exten => 8000,n,Set(current_min=${STRFTIME(${EPOCH},,%M)})
exten => 8000,n,NoOp(Extensión: ${extension} - Día actual: ${current_day} - Hora actual: ${current_hour}:${current_min})
exten => 8000,n,System(mysql -u root -pBlackBopys asterisk -e "SELECT dias_semana FROM esp32_authorized_extensions WHERE extension='${extension}' AND activo=1" -s -N > /tmp/dias_${extension})
exten => 8000,n,Set(dias_semana=${FILE(/tmp/dias_${extension},0,7)})
exten => 8000,n,NoOp(Días permitidos: ${dias_semana})
exten => 8000,n,GotoIf($["${dias_semana}" = ""]?no_autorizado:check_day)
exten => 8000,n(check_day),Set(dia_permitido=${dias_semana:${current_day}:1})
exten => 8000,n,NoOp(Día ${current_day} permitido: ${dia_permitido})
exten => 8000,n,GotoIf($["${dia_permitido}" = "1"]?check_time:no_autorizado)
exten => 8000,n(check_time),System(mysql -u root -pBlackBopys asterisk -e "SELECT HOUR(hora_inicio) FROM esp32_authorized_extensions WHERE extension='${extension}' AND activo=1" -s -N > /tmp/hi_${extension})
exten => 8000,n,System(mysql -u root -pBlackBopys asterisk -e "SELECT MINUTE(hora_inicio) FROM esp32_authorized_extensions WHERE extension='${extension}' AND activo=1" -s -N > /tmp/mi_${extension})
exten => 8000,n,System(mysql -u root -pBlackBopys asterisk -e "SELECT HOUR(hora_fin) FROM esp32_authorized_extensions WHERE extension='${extension}' AND activo=1" -s -N > /tmp/hf_${extension})
exten => 8000,n,System(mysql -u root -pBlackBopys asterisk -e "SELECT MINUTE(hora_fin) FROM esp32_authorized_extensions WHERE extension='${extension}' AND activo=1" -s -N > /tmp/mf_${extension})
exten => 8000,n,Set(hora_inicio_h=${FILE(/tmp/hi_${extension},0,2)})
exten => 8000,n,Set(hora_inicio_m=${FILE(/tmp/mi_${extension},0,2)})
exten => 8000,n,Set(hora_fin_h=${FILE(/tmp/hf_${extension},0,2)})
exten => 8000,n,Set(hora_fin_m=${FILE(/tmp/mf_${extension},0,2)})
exten => 8000,n,Set(current_time_min=$[${current_hour} * 60 + ${current_min}])
exten => 8000,n,Set(inicio_time_min=$[${hora_inicio_h} * 60 + ${hora_inicio_m}])
exten => 8000,n,Set(fin_time_min=$[${hora_fin_h} * 60 + ${hora_fin_m}])
exten => 8000,n,NoOp(Horario: ${current_time_min}min actual vs ${inicio_time_min}-${fin_time_min}min permitido)
exten => 8000,n,GotoIf($[${current_time_min} >= ${inicio_time_min} & ${current_time_min} <= ${fin_time_min}]?autorizado:no_autorizado)
exten => 8000,n(no_autorizado),NoOp(Acceso denegado)
exten => 8000,n,System(mysql -u root -pBlackBopys asterisk -e "INSERT INTO esp32_access_log (fecha_hora,extension_llamante,ip_esp32,accion,resultado) VALUES (NOW(),'${extension}','192.168.1.26','ACCESS','UNAUTHORIZED')")
exten => 8000,n,Hangup()
exten => 8000,n(autorizado),Set(intentos=1)
exten => 8000,n(loop),Playback(es/access-code)
exten => 8000,n,Read(codigo,beep,3,,,10)
exten => 8000,n,NoOp(Código ingresado: ${codigo} - Intento: ${intentos})
exten => 8000,n,GotoIf($["${codigo}" = "100"]?correcto:incorrecto)
exten => 8000,n(correcto),NoOp(Código CORRECTO)
exten => 8000,n,System(curl "http://192.168.1.26/on?token=mi_token_secreto")
exten => 8000,n,System(mysql -u root -pBlackBopys asterisk -e "INSERT INTO esp32_access_log (fecha_hora,extension_llamante,ip_esp32,accion,resultado) VALUES (NOW(),'${extension}','192.168.1.26','ON','OK')")
exten => 8000,n,Playback(es/pin-number-accepted)
exten => 8000,n,Hangup()
exten => 8000,n(incorrecto),NoOp(Código INCORRECTO)
exten => 8000,n,Set(intentos=$[${intentos} + 1])
exten => 8000,n,GotoIf($[${intentos} > 3]?fin:loop)
exten => 8000,n,Goto(loop)
exten => 8000,n(fin),System(mysql -u root -pBlackBopys asterisk -e "INSERT INTO esp32_access_log (fecha_hora,extension_llamante,ip_esp32,accion,resultado) VALUES (NOW(),'${extension}','192.168.1.26','ACCESS','FAILED_ATTEMPTS')")
exten => 8000,n,Playback(vm-goodbye)
exten => 8000,n,Hangup()